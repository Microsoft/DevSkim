@page "/reports"
@using Microsoft.CodeAnalysis.Sarif;
@inject Blazored.LocalStorage.ILocalStorageService localStorage;

<h1>Report Viewer</h1>

<div>Select Run</div>
<Dropdown TItem="string" OnSelected="@OnSelected">
    <ChildContent>
        <div class="dropdown-divider"></div>
        @foreach (var runId in RunList)
        {
            <DropdownListItem Item="@runId">@runId</DropdownListItem>
        }
    </ChildContent>
</Dropdown>

<br />

<button @onclick="GetResults">Get Results</button>

<br />

<div style="width:800px; height:300px; border-style:solid; border-color:black;">@Status</div>
<div style="width:800px; height:1200px; border-style:solid; border-color:black;">
    @foreach (var finding in Findings)
    {
        <div>
           <span>@finding.Key</span> <a href="/viewcode/@finding.Value">@finding.Value</a>
        </div>
    }
</div>

@code {
    private static string nl = Environment.NewLine;
    private string SelectedRun { get; set; } = "";
    public string Status { get; set; } = "Idle";
    public IList<string> RunList = new List<string> {};
    public IDictionary<string, string> Findings = new Dictionary<string, string>();


    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await ReadStorage();
        }
    }

    private void OnSelected(string selection)
    {
        SelectedRun = selection;
    }

    public async Task ReadStorage()
    {
        try
        {
            Status = $"Reading storage...{nl}";
            this.StateHasChanged();
            var res = await localStorage.GetItemAsync<Results>("DevSkimResults");
            if (res == null)
                res = new Results();
            RunList = res.RunIds;

            Status += $"Found {RunList.Count} runs.{nl}";
            this.StateHasChanged();
        }
        catch (Exception e)
        {
            var message = e.Message;
            var stackTrace = e.StackTrace;
            var type = e.GetType();
            var name = type.Name;
            Console.WriteLine(e.Message);
        }
    }

    public async Task GetResults()
    {
        var runId = SelectedRun;
        if (String.IsNullOrWhiteSpace(runId))
        {
            Status += $"No run selected.{nl}";
            this.StateHasChanged();
            return;
        }

        Status += $"Reading results of Run ID: {runId}{nl}";
        this.StateHasChanged();

        var res = await localStorage.GetItemAsync<Results>("DevSkimResults");
        foreach (var item in res.FileLocations[runId])
        {
            Findings.Add(item.Key, item.Value);
        }
        Status += $"Finished reading results of Run ID: {SelectedRun}{nl}";
        this.StateHasChanged();
    }
}